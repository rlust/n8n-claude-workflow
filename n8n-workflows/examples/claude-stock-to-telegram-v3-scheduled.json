{
  "name": "Stock to Telegram v3 (Working)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "stock-telegram-v3",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-1",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        240,
        400
      ],
      "webhookId": "stock-telegram-v3"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "30 9 * * 1-5"
            }
          ]
        }
      },
      "id": "cron-morning",
      "name": "Morning Summary Trigger",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1.1,
      "position": [
        240,
        200
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "symbol1-default",
              "name": "symbol1",
              "value": "AAPL",
              "type": "string"
            },
            {
              "id": "symbol2-default",
              "name": "symbol2",
              "value": "MSFT",
              "type": "string"
            },
            {
              "id": "symbol3-default",
              "name": "symbol3",
              "value": "PRK",
              "type": "string"
            },
            {
              "id": "symbol4-default",
              "name": "symbol4",
              "value": "QQQ",
              "type": "string"
            },
            {
              "id": "symbol5-default",
              "name": "symbol5",
              "value": "F",
              "type": "string"
            },
            {
              "id": "chat-id-default",
              "name": "chat_id",
              "value": "1955999067",
              "type": "string"
            },
            {
              "id": "send-telegram-default",
              "name": "send_telegram",
              "value": true,
              "type": "boolean"
            }
          ]
        }
      },
      "id": "set-cron-defaults",
      "name": "Set Cron Defaults",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        460,
        200
      ]
    },
    {
      "parameters": {
        "mode": "append",
        "options": {}
      },
      "id": "merge-triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        680,
        300
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "symbol1",
              "name": "symbol1",
              "value": "={{ $json.body.symbols ? $json.body.symbols.split(',')[0].trim() : 'AAPL' }}",
              "type": "string"
            },
            {
              "id": "symbol2",
              "name": "symbol2",
              "value": "={{ $json.body.symbols ? $json.body.symbols.split(',')[1]?.trim() || 'MSFT' : 'MSFT' }}",
              "type": "string"
            },
            {
              "id": "symbol3",
              "name": "symbol3",
              "value": "={{ $json.body.symbols ? $json.body.symbols.split(',')[2]?.trim() || 'PRK' : 'PRK' }}",
              "type": "string"
            },
            {
              "id": "symbol4",
              "name": "symbol4",
              "value": "={{ $json.body.symbols ? $json.body.symbols.split(',')[3]?.trim() || 'QQQ' : 'QQQ' }}",
              "type": "string"
            },
            {
              "id": "symbol5",
              "name": "symbol5",
              "value": "={{ $json.body.symbols ? $json.body.symbols.split(',')[4]?.trim() || 'F' : 'F' }}",
              "type": "string"
            },
            {
              "id": "chat_id",
              "name": "chat_id",
              "value": "={{ $json.body.chat_id || '1955999067' }}",
              "type": "string"
            },
            {
              "id": "send_telegram",
              "name": "send_telegram",
              "value": "={{ $json.body.send_to_telegram !== false }}",
              "type": "boolean"
            }
          ]
        }
      },
      "id": "set-params",
      "name": "Extract Params",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        460,
        400
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://query1.finance.yahoo.com/v8/finance/chart/{{ $json.symbol1 }}?interval=1d&range=5d"
      },
      "id": "http-1",
      "name": "Fetch Stock 1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        900,
        200
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://query1.finance.yahoo.com/v8/finance/chart/{{ $json.symbol2 }}?interval=1d&range=5d"
      },
      "id": "http-2",
      "name": "Fetch Stock 2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        900,
        400
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://query1.finance.yahoo.com/v8/finance/chart/{{ $json.symbol3 }}?interval=1d&range=5d"
      },
      "id": "http-3",
      "name": "Fetch Stock 3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        900,
        600
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://query1.finance.yahoo.com/v8/finance/chart/{{ $json.symbol4 }}?interval=1d&range=5d"
      },
      "id": "http-4",
      "name": "Fetch Stock 4",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        900,
        800
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://query1.finance.yahoo.com/v8/finance/chart/{{ $json.symbol5 }}?interval=1d&range=5d"
      },
      "id": "http-5",
      "name": "Fetch Stock 5",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        900,
        1000
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "symbol",
              "name": "symbol",
              "value": "={{ $json.chart.result[0].meta.symbol }}",
              "type": "string"
            },
            {
              "id": "price",
              "name": "price",
              "value": "={{ $json.chart.result[0].meta.regularMarketPrice }}",
              "type": "number"
            },
            {
              "id": "prev_close",
              "name": "prev_close",
              "value": "={{ $json.chart.result[0].meta.chartPreviousClose }}",
              "type": "number"
            },
            {
              "id": "change",
              "name": "change",
              "value": "={{ $json.chart.result[0].meta.regularMarketPrice - $json.chart.result[0].meta.chartPreviousClose }}",
              "type": "number"
            },
            {
              "id": "change_pct",
              "name": "change_pct",
              "value": "={{ (($json.chart.result[0].meta.regularMarketPrice - $json.chart.result[0].meta.chartPreviousClose) / $json.chart.result[0].meta.chartPreviousClose * 100).toFixed(2) }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "set-1",
      "name": "Parse Stock 1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        1120,
        200
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "symbol",
              "name": "symbol",
              "value": "={{ $json.chart.result[0].meta.symbol }}",
              "type": "string"
            },
            {
              "id": "price",
              "name": "price",
              "value": "={{ $json.chart.result[0].meta.regularMarketPrice }}",
              "type": "number"
            },
            {
              "id": "prev_close",
              "name": "prev_close",
              "value": "={{ $json.chart.result[0].meta.chartPreviousClose }}",
              "type": "number"
            },
            {
              "id": "change",
              "name": "change",
              "value": "={{ $json.chart.result[0].meta.regularMarketPrice - $json.chart.result[0].meta.chartPreviousClose }}",
              "type": "number"
            },
            {
              "id": "change_pct",
              "name": "change_pct",
              "value": "={{ (($json.chart.result[0].meta.regularMarketPrice - $json.chart.result[0].meta.chartPreviousClose) / $json.chart.result[0].meta.chartPreviousClose * 100).toFixed(2) }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "set-2",
      "name": "Parse Stock 2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        1120,
        400
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "symbol",
              "name": "symbol",
              "value": "={{ $json.chart.result[0].meta.symbol }}",
              "type": "string"
            },
            {
              "id": "price",
              "name": "price",
              "value": "={{ $json.chart.result[0].meta.regularMarketPrice }}",
              "type": "number"
            },
            {
              "id": "prev_close",
              "name": "prev_close",
              "value": "={{ $json.chart.result[0].meta.chartPreviousClose }}",
              "type": "number"
            },
            {
              "id": "change",
              "name": "change",
              "value": "={{ $json.chart.result[0].meta.regularMarketPrice - $json.chart.result[0].meta.chartPreviousClose }}",
              "type": "number"
            },
            {
              "id": "change_pct",
              "name": "change_pct",
              "value": "={{ (($json.chart.result[0].meta.regularMarketPrice - $json.chart.result[0].meta.chartPreviousClose) / $json.chart.result[0].meta.chartPreviousClose * 100).toFixed(2) }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "set-3",
      "name": "Parse Stock 3",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        1120,
        600
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "symbol",
              "name": "symbol",
              "value": "={{ $json.chart.result[0].meta.symbol }}",
              "type": "string"
            },
            {
              "id": "price",
              "name": "price",
              "value": "={{ $json.chart.result[0].meta.regularMarketPrice }}",
              "type": "number"
            },
            {
              "id": "prev_close",
              "name": "prev_close",
              "value": "={{ $json.chart.result[0].meta.chartPreviousClose }}",
              "type": "number"
            },
            {
              "id": "change",
              "name": "change",
              "value": "={{ $json.chart.result[0].meta.regularMarketPrice - $json.chart.result[0].meta.chartPreviousClose }}",
              "type": "number"
            },
            {
              "id": "change_pct",
              "name": "change_pct",
              "value": "={{ (($json.chart.result[0].meta.regularMarketPrice - $json.chart.result[0].meta.chartPreviousClose) / $json.chart.result[0].meta.chartPreviousClose * 100).toFixed(2) }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "set-4",
      "name": "Parse Stock 4",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        1120,
        800
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "symbol",
              "name": "symbol",
              "value": "={{ $json.chart.result[0].meta.symbol }}",
              "type": "string"
            },
            {
              "id": "price",
              "name": "price",
              "value": "={{ $json.chart.result[0].meta.regularMarketPrice }}",
              "type": "number"
            },
            {
              "id": "prev_close",
              "name": "prev_close",
              "value": "={{ $json.chart.result[0].meta.chartPreviousClose }}",
              "type": "number"
            },
            {
              "id": "change",
              "name": "change",
              "value": "={{ $json.chart.result[0].meta.regularMarketPrice - $json.chart.result[0].meta.chartPreviousClose }}",
              "type": "number"
            },
            {
              "id": "change_pct",
              "name": "change_pct",
              "value": "={{ (($json.chart.result[0].meta.regularMarketPrice - $json.chart.result[0].meta.chartPreviousClose) / $json.chart.result[0].meta.chartPreviousClose * 100).toFixed(2) }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "set-5",
      "name": "Parse Stock 5",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        1120,
        1000
      ]
    },
    {
      "parameters": {
        "mode": "append"
      },
      "id": "merge-1",
      "name": "Merge Stocks",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        1340,
        300
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prompt",
              "name": "prompt",
              "value": "={{ 'Analyze these stocks:\\n\\n' + $('Merge Stocks').all().map((item, index) => item.json.symbol + ': $' + item.json.price + ' (' + (item.json.change >= 0 ? '+' : '') + item.json.change_pct + '%)').join('\\n') + '\\n\\nProvide a brief analysis in Telegram Markdown format:\\n1. Overall market sentiment\\n2. Key observations for each stock\\n3. Brief outlook\\n\\nUse *bold*, _italic_, and emojis. Start with \"ðŸ“Š *Stock Market Analysis*\"' }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "set-prompt",
      "name": "Build Prompt",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        1560,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\"model\": \"claude-sonnet-4-5-20250929\", \"max_tokens\": 1024, \"messages\": [{\"role\": \"user\", \"content\": $json.prompt}]} }}"
      },
      "id": "http-claude",
      "name": "Call Claude",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1780,
        300
      ],
      "credentials": {
        "anthropicApi": {
          "id": "REYgTvbzUh2zQgDS",
          "name": "x-api-key"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "analysis",
              "name": "analysis",
              "value": "={{ $json.content[0].text }}",
              "type": "string"
            },
            {
              "id": "chat_id",
              "name": "chat_id",
              "value": "={{ $('Merge Triggers').item.json.chat_id }}",
              "type": "string"
            },
            {
              "id": "send_telegram",
              "name": "send_telegram",
              "value": "={{ $('Merge Triggers').item.json.send_telegram }}",
              "type": "boolean"
            },
            {
              "id": "tokens",
              "name": "tokens",
              "value": "={{ $json.usage.input_tokens + $json.usage.output_tokens }}",
              "type": "number"
            }
          ]
        }
      },
      "id": "set-extract",
      "name": "Extract Analysis",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        2000,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.send_telegram }}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-1",
      "name": "Send Telegram?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2220,
        300
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.analysis }}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "disable_web_page_preview": true
        }
      },
      "id": "telegram-1",
      "name": "Send to Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.1,
      "position": [
        2440,
        200
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "success",
              "name": "success",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "telegram_sent",
              "name": "telegram_sent",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "telegram_id",
              "name": "telegram_message_id",
              "value": "={{ $json.message_id }}",
              "type": "number"
            }
          ]
        }
      },
      "id": "set-telegram-response",
      "name": "Telegram Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        2660,
        200
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "success",
              "name": "success",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "telegram_sent",
              "name": "telegram_sent",
              "value": false,
              "type": "boolean"
            }
          ]
        }
      },
      "id": "set-no-telegram",
      "name": "No Telegram Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        2440,
        400
      ]
    },
    {
      "parameters": {
        "mode": "append"
      },
      "id": "merge-2",
      "name": "Merge Responses",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        2880,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": $json.success,\n  \"symbols\": $('Merge Triggers').item.json.symbol1 + ',' + $('Merge Triggers').item.json.symbol2 + ',' + $('Merge Triggers').item.json.symbol3 + ',' + $('Merge Triggers').item.json.symbol4 + ',' + $('Merge Triggers').item.json.symbol5,\n  \"analysis\": $('Extract Analysis').item.json.analysis,\n  \"tokens_used\": $('Extract Analysis').item.json.tokens,\n  \"telegram_sent\": $json.telegram_sent,\n  \"telegram_message_id\": $json.telegram_message_id || null\n} }}"
      },
      "id": "respond-1",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        3100,
        300
      ]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Extract Params",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Params": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Fetch Stock 1": {
      "main": [
        [
          {
            "node": "Parse Stock 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Stock 2": {
      "main": [
        [
          {
            "node": "Parse Stock 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Stock 1": {
      "main": [
        [
          {
            "node": "Merge Stocks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Stock 2": {
      "main": [
        [
          {
            "node": "Merge Stocks",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Stocks": {
      "main": [
        [
          {
            "node": "Build Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Prompt": {
      "main": [
        [
          {
            "node": "Call Claude",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Claude": {
      "main": [
        [
          {
            "node": "Extract Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Analysis": {
      "main": [
        [
          {
            "node": "Send Telegram?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Telegram?": {
      "main": [
        [
          {
            "node": "Send to Telegram",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Telegram Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to Telegram": {
      "main": [
        [
          {
            "node": "Telegram Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Response": {
      "main": [
        [
          {
            "node": "Merge Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Telegram Response": {
      "main": [
        [
          {
            "node": "Merge Responses",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Responses": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Morning Summary Trigger": {
      "main": [
        [
          {
            "node": "Set Cron Defaults",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Cron Defaults": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "Fetch Stock 1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Stock 2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Stock 3",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Stock 4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Stock 5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Stock 3": {
      "main": [
        [
          {
            "node": "Parse Stock 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Stock 4": {
      "main": [
        [
          {
            "node": "Parse Stock 4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Stock 5": {
      "main": [
        [
          {
            "node": "Parse Stock 5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Stock 3": {
      "main": [
        [
          {
            "node": "Merge Stocks",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Parse Stock 4": {
      "main": [
        [
          {
            "node": "Merge Stocks",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Parse Stock 5": {
      "main": [
        [
          {
            "node": "Merge Stocks",
            "type": "main",
            "index": 4
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": []
}